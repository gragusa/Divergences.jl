#!/usr/bin/env julia

using AirspeedVelocity
using Dates
using Pkg: PackageSpec

const PKG_NAME = "MinimumDivergenceEstimators"
const REPO_ROOT = abspath(joinpath(@__DIR__, ".."))
const BENCH_SCRIPT = joinpath(@__DIR__, "benchmarks.jl")
const BENCH_PROJECT = joinpath(@__DIR__, "Project.toml")

const OUTPUT_DIR = abspath(get(ENV, "ASV_OUTPUT_DIR", joinpath(@__DIR__, "results")))
const BASELINE_REV = get(ENV, "ASV_BASELINE", "HEAD")
const CANDIDATE_REV = get(ENV, "ASV_CANDIDATE", "dirty")
const TUNE_BENCH = lowercase(get(ENV, "ASV_TUNE", "false")) in ("1", "true", "yes")
const NSAMPLES_LOAD_TIME = parse(Int, get(ENV, "ASV_LOAD_SAMPLES", "5"))

mkpath(OUTPUT_DIR)

baseline_spec = PackageSpec(; name = PKG_NAME, rev = BASELINE_REV, path = REPO_ROOT)
candidate_spec = PackageSpec(; name = PKG_NAME, rev = CANDIDATE_REV, path = REPO_ROOT)
specs = [baseline_spec, candidate_spec]

println("== AirspeedVelocity Benchmark: $PKG_NAME ==")
println(" Baseline:  $BASELINE_REV")
println(" Candidate: $CANDIDATE_REV")
println(" Output:    $OUTPUT_DIR")

results = AirspeedVelocity.benchmark(
    specs;
    output_dir = OUTPUT_DIR,
    script = BENCH_SCRIPT,
    project_toml = BENCH_PROJECT,
    tune = TUNE_BENCH,
    nsamples_load_time = NSAMPLES_LOAD_TIME
)

timestamp = Dates.format(Dates.now(), dateformat"yyyy-mm-ddTHHMM")
summary_path = joinpath(OUTPUT_DIR, "summary_$timestamp.md")

combined = AirspeedVelocity.load_results(specs; input_dir = OUTPUT_DIR)
table_md = AirspeedVelocity.create_table(combined)

open(summary_path, "w") do io
    println(io, "# Benchmark Summary: $PKG_NAME ($timestamp)")
    println(io)
    println(io, "Comparing `$BASELINE_REV` (baseline) vs `$CANDIDATE_REV` (candidate)")
    println(io)
    println(io, table_md)
    println(io)
    println(io, "_Generated by benchmark/run_asv.jl_")
end

println("== Complete ==")
println(" Summary: $summary_path")
